/*
 * Butter Track Widgter jquery.ui.butter.js
 * Version 0.1.0
 * 
 * Developed by Bocoup on behalf of the Mozilla Foundation
 * Copyright (c) 2011 Bocoup, LLC
 * Authors: Alistair McDonald
 * Dual licensed under the MIT and GPL licenses.
 * http://code.bocoup.com/license/
 *
 */
(function(j,g,h,m){function l(a,d){h.extend(this,a);this.parent=d;this.xr=this.xl=this.oxr=this.oxl=0;this.hovered=false;this.draw();return this}var n=-1,k={trackEvent:{defaults:function(a,d,c,e,b){if(!isNaN(d)){c=a.createLinearGradient(0,0,0,b);c.addColorStop(0,"rgba( 255, 255, 0, 0.3 )");c.addColorStop(1,"rgba( 255, 255, 0, 0.3 )");a.fillStyle=c;a.fillRect(d,1.5,e,b-1.5);a.fillStyle="rgba(255,255,255,.125)";a.fillRect(d,0,e,b/2);a.lineWidth=0.5;a.fillStyle="#FF0";a.fillRect(d,3,1,b-5);a.fillRect(d+
e-1,3,1,b-5)}},hover:function(a,d,c,e,b){if(!isNaN(d)){a.fillStyle="#FF0";a.fillRect(d,1.5,e,b-1.5);c=a.createLinearGradient(0,0,0,b);c.addColorStop(0,"rgba(255,255,255,.7)");c.addColorStop(1,"rgba(0,0,0,.25)");a.fillStyle=c;a.fillRect(d,0,e,b);a.fillStyle="#FF0";a.fillRect(d,0,1,b);a.fillRect(d+e-1,0,1,b);a.fillRect(d,b-1.5,e,2);a.fillRect(d,0,e,1)}},thumb:{left:{defaults:function(a,d,c,e,b){a.fillStyle="#880";a.fillRect(d,0,8,b);a.fillStyle="#FF0";a.fillRect(d,0,1,b)}},right:{defaults:function(a,
d,c,e,b){a.fillStyle="#880";a.fillRect(d+e-9,0,8,b);a.fillStyle="#FF0";a.fillRect(d+e-1,0,1,b)}}}},zoomEvent:{defaults:function(a,d,c,e,b){c=a.createLinearGradient(0,0,0,b);c.addColorStop(0,"rgba( 128, 255, 0, 0.3 )");c.addColorStop(1,"rgba( 128, 255, 0, 0.3 )");a.fillStyle=c;a.fillRect(d,1.5,e,b-1.5);a.fillStyle="rgba(255,255,255,.125)";a.fillRect(d,0,e,b/2);a.lineWidth=0.5;a.fillStyle="#AF0";a.fillRect(d,3,1,b-5);a.fillRect(d+e-1,3,1,b-5)},hover:function(a,d,c,e,b){a.fillStyle="#AF0";a.fillRect(d,
1.5,e,b-1.5);c=a.createLinearGradient(0,0,0,b);c.addColorStop(0,"rgba(128,255,0,.7)");c.addColorStop(1,"rgba(0,0,0,.25)");a.fillStyle=c;a.fillRect(d,0,e,b);a.fillStyle="#AF0";a.fillRect(d,0,1,b);a.fillRect(d+e-1,0,1,b);a.fillRect(d,b-1.5,e,2);a.fillRect(d,0,e,1)},thumb:{left:{defaults:function(a,d,c,e,b){a.fillStyle="#480";a.fillRect(d,0,16,b);a.fillStyle="#AF0";a.fillRect(d,0,4,b)}},right:{defaults:function(a,d,c,e,b){a.fillStyle="#480";a.fillRect(d+e-17,0,16,b);a.fillStyle="#AF0";a.fillRect(d+e-
4,0,4,b)}}}}};l.prototype.draw=function(a,d){var c=this.xl=this.oxl+this.parent.width/this.parent.options.duration*this.inPoint,e=this.parent.width/this.parent.options.duration*(this.outPoint-this.inPoint),b=this.parent.height,f=this.parent.context,i;c=c*100/this.parent.zoomWindow.width-this.parent.zoomWindow.offsetX*100;e=e*100/this.parent.zoomWindow.width;this.xr=c+e;i=this.parent.options.mode==="smartZoom"?"zoomEvent":"trackEvent";if(this.hovered){k[i].hover(f,c,null,e,b);a&&k[i].thumb.left.defaults(f,
c,null,e,b);d&&k[i].thumb.right.defaults(f,c,null,e,b)}else k[i].defaults(f,c,null,e,b)};h.widget("butter.track",{options:{},_init:function(){this.index=n++;this._inView=[];this.hovering=null;this._loadedmetadata=function(a){this.options.duration=a.currentTarget.duration};this._playBar={position:0};this.width=this.element.width();this.height=this.element.height();h.extend(this,{context:function(a,d){var c;c=g.createElement("canvas");c.width=a;c.height=d;return c.getContext("2d")}(this.width,this.height),
scrubBar:{position:0,width:3},mouse:{x:0,y:0,down:false,lastX:0,lastY:0,mode:100},zoomWindow:{offsetX:0,width:100}});h.extend(this.options,{style:{outerBar:{lineWidth:1,strokeStyle:"#888"},playBar:{lineWidth:1,strokeStyle:"#f00"}}});this.options.mode==="smartZoom"&&this._inView.push(new l({inPoint:0,outPoint:100,duration:100},this));this.element.append(this.context.canvas);if(this.options.target){this.options.target.bind("timeupdate.track",h.proxy(this._timeupdate,this));this.options.target.bind("loadedmetadata.track",
h.proxy(this._loadedmetadata,this))}this.element.bind("mousemove.track",h.proxy(this._mousemove,this));this.element.bind("mousedown.track mouseup.track",h.proxy(this._mouseupdown,this));this.element.bind("mouseenter.track mouseleave.track",h.proxy(this._hover,this));this._draw();return this},_style:function(a){for(var d in a)this.context[d]=a[d]},killTrackEvent:function(a){var d=[];m.each(this._inView,function(c){c._id!==a._id&&d.push(c)});this._inView=d},addTrackEvent:function(a){return this._inView.push(new l(a,
this))},zoom:function(a){this.zoomWindow.offsetX=a.offsetX;this.zoomWindow.width=a.width;this._draw()},_draw:function(a,d){h(g).trigger("drawStart.track");var c=this.context,e=c.canvas,b=e.width,f=e.height,i=c.createLinearGradient(0,0,0,f);e=0;var o=this._inView.length;i.addColorStop(0,"#fff");i.addColorStop(1,"#B6B6B6");c.fillStyle=i;c.fillRect(0,0,b,f);c.strokeStyle="#9D9D9D";c.lineWidth=0;for(c.strokeRect(0.5,0.5,b-1,f-1);e<o;e++){c=this._inView[e];c.draw(a,d)}h(g).trigger("drawComplete.track")},
_timeupdate:function(a){this._playBar.position=a.currentTarget.currentTime;this._draw()},_mousemove:function(a){a=a.originalEvent;this.mouse.lastX=this.mouse.x;this.mouse.lastY=this.mouse.y;var d=j.scrollY!==null&&typeof j.scrollY!=="undefined"?j.scrollY:j.pageYOffset,c=0,e=this._inView.length,b,f;this.mouse.x=a.clientX-this.element[0].offsetLeft+(j.scrollX!==null&&typeof j.scrollX!=="undefined"?j.scrollX:j.pageXOffset);this.mouse.y=a.clientY-this.element[0].offsetTop+d;a=d=false;if(!this.mouse.down){for(this.mouse.hovering=
null;c<e;c++){b=this._inView[c];if(b.xl<=this.mouse.x&&b.xr>=this.mouse.x){if(!b.hovered){b.hovered=true;this.mouse.hovering=b}this.mouse.hovering=b;this.mouse.hovering.grabX=this.mouse.x-this.mouse.hovering.xl+1;if(this.mouse.x>=b.xl&&this.mouse.x<=b.xl+8){g.body.style.cursor="w-resize";a=true}else if(this.mouse.x>=b.xr-8&&this.mouse.x<=b.xr){g.body.style.cursor="e-resize";d=true}else g.body.style.cursor="move"}else if(b.hovered){b.hovered=false;this.mouse.hovering=null;this._draw()}}if(!this.mouse.hovering){this.mouse.mode=
100;g.body.style.cursor="auto";return}}b=this.mouse.hovering;if(this.mouse.down){if(this.mouse.mode===100&&this.mouse.hovering)if(this.mouse.x>=b.xl&&this.mouse.x<=b.xl+8)this.mouse.mode=102;else if(this.mouse.x>=b.xr-8&&this.mouse.x<=b.xr)this.mouse.mode=101;else if(this.mouse.x>=b.xl+8&&this.mouse.x<=b.xr-8)this.mouse.mode=103;a=d=false;if(this.mouse.mode===101){d=true;g.body.style.cursor="e-resize";this.mouse.hovering.outPoint=this.options.duration/this.width*(this.mouse.x+4);if(this.options.mode!==
"smartZoom")this.mouse.hovering.popcornEvent.end=this.mouse.hovering.outPoint;else{c=this.options.linkedTracks;for(f in c)c[f].track("zoom",{offsetX:this.mouse.hovering.inPoint,width:this.mouse.hovering.outPoint-this.mouse.hovering.inPoint})}}else if(this.mouse.mode===102){a=true;g.body.style.cursor="w-resize";this.mouse.hovering.inPoint=this.options.duration/this.width*(this.mouse.x-4);if(this.options.mode!=="smartZoom")this.mouse.hovering.popcornEvent.start=this.mouse.hovering.inPoint;else{c=this.options.linkedTracks;
for(f in c)c[f].track("zoom",{offsetX:this.mouse.hovering.inPoint,width:this.mouse.hovering.outPoint-this.mouse.hovering.inPoint})}}else if(this.mouse.mode===103){g.body.style.cursor="move";c=this.mouse.hovering.outPoint-this.mouse.hovering.inPoint;this.mouse.hovering.inPoint=(this.mouse.x-this.mouse.hovering.grabX)/this.width*this.options.duration;this.mouse.hovering.outPoint=this.mouse.hovering.inPoint+c;if(this.options.mode!=="smartZoom"){this.mouse.hovering.popcornEvent.start=this.mouse.hovering.inPoint;
this.mouse.hovering.popcornEvent.end=this.mouse.hovering.outPoint}else{c=this.options.linkedTracks;for(f in c)c[f].track("zoom",{offsetX:this.mouse.hovering.inPoint,width:this.mouse.hovering.outPoint-this.mouse.hovering.inPoint})}}}this._draw(a,d)},_mouseupdown:function(a){if(a.type==="mousedown")this.mouse.down=true;else if(a.type==="mouseup"){if(this.mouse.hovering&&this.mouse.down){this.options.mode!=="smartZoom"&&this.mouse.hovering.editEvent(a);this.mouse.hovering=null}this.mouse.down=false;
this._draw()}},_hover:function(a){if(a.type==="mouseenter")this._draw();else if(a.type==="mouseleave"){if(this.mouse.hovering)this.mouse.hovering.hovered=false;g.body.style.cursor="auto";this._draw()}},myPublicMethod:function(){},_setOption:function(){},destroy:function(){},option:function(){},setData:function(){},enable:function(){},disable:function(){}})})(this,this.document,this.jQuery,this._,this.Popcorn);